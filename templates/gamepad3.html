<!DOCTYPE html>
<html>
<head>
  <title>Robocup Cams</title>
  <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
</head>
<body>
  
  <h1>Robocup Camera Stream '23</h1>

</body>

<script>
  //connect gamepad from window
  window.addEventListener("gamepadconnected", function(e) {
    console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
      e.gamepad.index, e.gamepad.id,
      e.gamepad.buttons.length, e.gamepad.axes.length);
  });
  //disconnect gamepad from window
  window.addEventListener("gamepaddisconnected", function(e) {
    console.log("Gamepad disconnected from index %d: %s",
      e.gamepad.index, e.gamepad.id);
  });
  //apply Deadzone so no motor running when at rest
  var applyDeadzone = function(number, threshold){
    percentage = (Math.abs(number) - threshold) / (1 - threshold);
    if(percentage < 0)
      percentage = 0;
    return percentage * (number > 0 ? 1 : -1);
  }
  function Variables() {
    var switcher = false;
    let toggle_mode = false;

    gp = navigator.getGamepads()[0];
    //Tread definitions
    let shutdown = gp.buttons[16].pressed;

    let joystick1 = applyDeadzone(gp.axes[1], 0.15);
    let joystick2 = applyDeadzone(gp.axes[3], 0.15);

    let frontLeftFlipperUp = gp.buttons[4].pressed;
    let frontLeftFlipperDown = gp.buttons[6].pressed;

    let frontRightFlipperUp = gp.buttons[5].pressed;
    let frontRightFlipperDown = gp.buttons[7].pressed;

    let backLeftFlipperUp = gp.buttons[13].pressed;
    let backLeftFlipperDown = gp.buttons[12].pressed;

    let backRightFlipperUp = gp.buttons[0].pressed;
    let backRightFlipperDown = gp.buttons[3].pressed;
    //End of Tread Defs

    //Arm definitions
    let shutdown2 = gp.buttons[16].pressed;

    let shoulderControls = applyDeadzone(gp.axes[1], 0.25);
    let elbowControls = applyDeadzone(gp.axes[3], 0.25);

    let turretControls = applyDeadzone(gp.axes[0], 0.25);
    let wristControls = applyDeadzone(gp.axes[2], 0.25);

    let clawOpen = gp.buttons[6].value;
    let clawClose = gp.buttons[7].value;
    //End of Arm Defs

    console.log("Variables Set")
  }

  function toggle() {
    toggle_mode = !toggle_mode;
  }

  function tread_mode() {

    if (gp.buttons[14].pressed) {
      toggle();
    }

    var dict = {
      'shutdown': shutdown,
      'joystick1': joystick1,
      'joystick2': joystick2,
      'frontLeftFlipperUp': frontLeftFlipperUp,
      'frontLeftFlipperDown': frontLeftFlipperDown,
      'frontRightFlipperUp': frontRightFlipperUp,
      'frontRightFlipperDown': frontRightFlipperDown,
      'backLeftFlipperUp': backLeftFlipperUp,
      'backLeftFlipperDown': backLeftFlipperDown,
      'backRightFlipperUp': backRightFlipperUp,
      'backRightFlipperDown': backRightFlipperDown
    };
    
    var socket = io();
    socket.emit('message', JSON.stringify(dict));

  }

  function turret_mode() {

    if (gp.buttons[14].pressed) {
      toggle();
    }

    var dict2 = {
      'shutdown2': shutdown2,
      'shoulderControls': shoulderControls,
      'elbowControls': elbowControls,
      'turretControls': turretControls,
      'wristControls': wristControls,
      'clawOpen': clawOpen,
      'clawClose': clawClose
    };

    var socket = io();
    socket.emit('message', JSON.stringify(dict2));

  }

  function run() {
    try {
      if (!toggle_mode && (frontLeftFlipperUp || frontLeftFlipperDown || frontRightFlipperUp || frontRightFlipperDown || backLeftFlipperUp || backLeftFlipperDown || backRightFlipperUp || backRightFlipperDown || joystick1 != 0 || joystick2 != 0 || shutdown)) {
      tread_mode();
      } 
      else if (toggle_mode && (frontLeftFlipperUp || frontLeftFlipperDown || frontRightFlipperUp || frontRightFlipperDown || backLeftFlipperUp || backLeftFlipperDown || backRightFlipperUp || backRightFlipperDown || joystick1 != 0 || joystick2 != 0 || shutdown)) {
      turret_mode();
      }
      else {
        console.log("No Input");

        var dictZero = {
          'shutdown': shutdown,
          'joystick1': joystick1,
          'joystick2': joystick2,
          'frontLeftFlipperUp': frontLeftFlipperUp,
          'frontLeftFlipperDown': frontLeftFlipperDown,
          'frontRightFlipperUp': frontRightFlipperUp,
          'frontRightFlipperDown': frontRightFlipperDown,
          'backLeftFlipperUp': backLeftFlipperUp,
          'backLeftFlipperDown': backLeftFlipperDown,
          'backRightFlipperUp': backRightFlipperUp,
          'backRightFlipperDown': backRightFlipperDown
        };

        shutdown = false;
        joystick1 = 0;
        joystick2 = 0;
        frontLeftFlipperUp = false;
        frontLeftFlipperDown = false;
        frontRightFlipperUp = false;
        frontRightFlipperDown = false;
        backLeftFlipperUp = false;
        backLeftFlipperDown = false;
        backRightFlipperUp = false;
        backRightFlipperDown = false;

        var socket = io();
        socket.emit('message', JSON.stringify(dictZero));
      }
    }
    catch(err) {
      console.log("Error: " + err.message + "");
    }
    
  }
  console.log("Starting Up...");;
  Variables();
  setInterval(run, 150);
</script>
</html>
