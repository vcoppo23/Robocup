<!DOCTYPE html>
<html>
<head>
  <title>Robocup Cams</title>
  <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

  <style>
    #circle {
      width: 200px;
      height: 200px;
      background-color: #ff0000;
      border-radius: 50%;
      border: black;
      color: white;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 50px;
      font-family: "Comic Sans MS";
      cursor: pointer;
      /* position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%); */
    }
    body {
      margin: 10px;
    }
    h1 {
      font-size: 25px;
      font-family: sans-serif;
    }
    .parent {
      display: grid;
      grid-gap: 5px;
      grid-template-columns: repeat(3, 320px);
      grid-template-rows: repeat(3, 240px);
    }
    .parent > div {
      padding: 0px;
      background-color: #e0e0e0;
      color: white;
      border-radius: 3px;
      display: grid;
      place-items: center;
    }

    .parent > div {
      font-family: sans-serif;
      font-size: 24px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  
  <h1>Robocup Camera Stream '23</h1>
  <div class="parent">
    <div><img src="http://192.168.20.144/video_feed1" title="Front Left"></div>
    <div><button id="circle" onclick="console.log()">Stop</button></div>
    <div><img src="http://192.168.20.144/video_feed2" title="Front Right"></div>
    <div>4</div>
    <div><img src="http://192.168.20.144/video_feed0" title="Arm"></div>
    <div>6</div>
    <div>7</div>
    <div><img src="http://192.168.20.144/video_feed3" title="Center Rear"></div>
    <div>9</div>
  </div>
  
</body>

<script>
  //connect gamepad from window
  window.addEventListener("gamepadconnected", function(e) {
    console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
      e.gamepad.index, e.gamepad.id,
      e.gamepad.buttons.length, e.gamepad.axes.length);
  });
  //disconnect gamepad from window
  window.addEventListener("gamepaddisconnected", function(e) {
    console.log("Gamepad disconnected from index %d: %s",
      e.gamepad.index, e.gamepad.id);
  });
  //apply Deadzone so no motor running when at rest
  var applyDeadzone = function(number, threshold){
    percentage = (Math.abs(number) - threshold) / (1 - threshold);
    if(percentage < 0)
      percentage = 0;
    return percentage * (number > 0 ? 1 : -1);
  }
  //runs python script in app.py
  var switcher = false;
  let toggle_mode = false;

  var gp = navigator.getGamepads()[0];

  console.log("Start of defs")

  //Tread definitions
  var shutdown = gp.buttons[16].pressed;

  var joystick1 = applyDeadzone(gp.axes[1], 0.15);
  var joystick2 = applyDeadzone(gp.axes[3], 0.15);

  var frontLeftFlipperUp = gp.buttons[4].pressed;
  var frontLeftFlipperDown = gp.buttons[6].pressed;

  var frontRightFlipperUp = gp.buttons[5].pressed;
  var frontRightFlipperDown = gp.buttons[7].pressed;

  var backLeftFlipperUp = gp.buttons[13].pressed;
  var backLeftFlipperDown = gp.buttons[12].pressed;

  var backRightFlipperUp = gp.buttons[0].pressed;
  var backRightFlipperDown = gp.buttons[3].pressed;
  //End of Tread Defs

  //Arm definitions
  var shutdown2 = gp.buttons[16].pressed;

  var shoulderControls = applyDeadzone(gp.axes[1], 0.25);
  var elbowControls = applyDeadzone(gp.axes[3], 0.25);

  var turretControls = applyDeadzone(gp.axes[0], 0.25);
  var wristControls = applyDeadzone(gp.axes[2], 0.25);

  var clawOpen = gp.buttons[6].value;
  var clawClose = gp.buttons[7].value;
  //End of Arm Defs
  console.log("end of defs")

  function toggle() {
    toggle_mode = !toggle_mode;
  }

  function tread_mode() {

    if (gp.buttons[14].pressed) {
      toggle();
    }

    var dict = {
      'shutdown': shutdown,
      'joystick1': joystick1,
      'joystick2': joystick2,
      'frontLeftFlipperUp': frontLeftFlipperUp,
      'frontLeftFlipperDown': frontLeftFlipperDown,
      'frontRightFlipperUp': frontRightFlipperUp,
      'frontRightFlipperDown': frontRightFlipperDown,
      'backLeftFlipperUp': backLeftFlipperUp,
      'backLeftFlipperDown': backLeftFlipperDown,
      'backRightFlipperUp': backRightFlipperUp,
      'backRightFlipperDown': backRightFlipperDown
    };

    $.ajax({
      url: "{{ url_for('mode_one') }}",
      type: 'POST',
      data: {'values': JSON.stringify(dict)},
      success: function(response) {
        console.log("Tread Mode Sent");

      }
    });  
  }

  function turret_mode() {

    if (gp.buttons[14].pressed) {
      toggle();
    }

    var dict = {
      'shutdown2': shutdown2,
      'shoulderControls': shoulderControls,
      'elbowControls': elbowControls,
      'turretControls': turretControls,
      'wristControls': wristControls,
      'clawOpen': clawOpen,
      'clawClose': clawClose
    }

    $.ajax({
      url: "{{ url_for('mode_two') }}",
      type: 'POST',
      data: {'values': JSON.stringify(dict)},
      success: function(response) {
        console.log("Turret Mode Sent");
      }
    });
  }

  function run() {
    if (!toggle_mode && (frontLeftFlipperUp || frontLeftFlipperDown || frontRightFlipperUp || frontRightFlipperDown || backLeftFlipperUp || backLeftFlipperDown || backRightFlipperUp || backRightFlipperDown || joystick1 != 0 || joystick2 != 0 || shutdown)) {
    tread_mode();
    } 
    else if (toggle_mode && (frontLeftFlipperUp || frontLeftFlipperDown || frontRightFlipperUp || frontRightFlipperDown || backLeftFlipperUp || backLeftFlipperDown || backRightFlipperUp || backRightFlipperDown || joystick1 != 0 || joystick2 != 0 || shutdown)) {
    turret_mode();
    }
    else {
      console.log("No Input");
    }
  }
  console.log("Running");
  setInterval(run, 200);
</script>
</html>
