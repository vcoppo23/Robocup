<!DOCTYPE html>
<html>
<head>
  <title>Robocup Cams</title>
  <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>
</head>
<body>
  
  <h1>Robocup Camera Stream '23</h1>

</body>

<script>
  //connect gamepad from window
  window.addEventListener("gamepadconnected", function(e) {
    console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
      e.gamepad.index, e.gamepad.id,
      e.gamepad.buttons.length, e.gamepad.axes.length);
  });

  //disconnect gamepad from window
  window.addEventListener("gamepaddisconnected", function(e) {
    console.log("Gamepad disconnected from index %d: %s",
      e.gamepad.index, e.gamepad.id);
  });
  //apply Deadzone so no motor running when at rest
  var applyDeadzone = function(number, threshold){
    percentage = (Math.abs(number) - threshold) / (1 - threshold);
    if(percentage < 0)
      percentage = 0;
    return percentage * (number > 0 ? 1 : -1);
  }

  var switcher = false;
  var toggle_mode = false;
  const socket = io();

  function toggle() {
    toggle_mode = !toggle_mode;
  }

  function tread_mode() {

    gp = navigator.getGamepads()[0];

    //Tread definitions
    shutdown = gp.buttons[16].pressed;

    joystick1 = applyDeadzone(gp.axes[1], 0.15);
    joystick2 = applyDeadzone(gp.axes[3], 0.15);

    frontLeftFlipperUp = gp.buttons[4].pressed;
    frontLeftFlipperDown = gp.buttons[6].pressed;

    frontRightFlipperUp = gp.buttons[5].pressed;
    frontRightFlipperDown = gp.buttons[7].pressed;

    backLeftFlipperUp = gp.buttons[13].pressed;
    backLeftFlipperDown = gp.buttons[12].pressed;

    backRightFlipperUp = gp.buttons[0].pressed;
    backRightFlipperDown = gp.buttons[3].pressed;
    //End of Tread Defs

    if (gp.buttons[14].pressed) {
      toggle();
    }

    var dict = {
      'shutdown': shutdown,
      'joystick1': joystick1,
      'joystick2': joystick2,
      'frontLeftFlipperUp': frontLeftFlipperUp,
      'frontLeftFlipperDown': frontLeftFlipperDown,
      'frontRightFlipperUp': frontRightFlipperUp,
      'frontRightFlipperDown': frontRightFlipperDown,
      'backLeftFlipperUp': backLeftFlipperUp,
      'backLeftFlipperDown': backLeftFlipperDown,
      'backRightFlipperUp': backRightFlipperUp,
      'backRightFlipperDown': backRightFlipperDown
    };

    socket.volatile.emit({'info': dict});

  }

  function turret_mode() {

    gp = navigator.getGamepads()[0];

    //Arm definitions
    shutdown2 = gp.buttons[16].pressed;

    shoulderControls = applyDeadzone(gp.axes[1], 0.25);
    elbowControls = applyDeadzone(gp.axes[3], 0.25);

    turretControls = applyDeadzone(gp.axes[0], 0.25);
    wristControls = applyDeadzone(gp.axes[2], 0.25);

    clawOpen = gp.buttons[6].value;
    clawClose = gp.buttons[7].value;
    //End of Arm Defs

    if (gp.buttons[14].pressed) {
      toggle();
      console.log("toggled");
    }

    var dict2 = {
      'shutdown2': shutdown2,
      'shoulderControls': shoulderControls,
      'elbowControls': elbowControls,
      'turretControls': turretControls,
      'wristControls': wristControls,
      'clawOpen': clawOpen,
      'clawClose': clawClose
    };
    
    socket.volatile.emit({'info': dict2});

  }

  function run() {

    gp = navigator.getGamepads()[0];

    //Tread definitions
    shutdown = gp.buttons[16].pressed;

    joystick1 = applyDeadzone(gp.axes[1], 0.15);
    joystick2 = applyDeadzone(gp.axes[3], 0.15);

    frontLeftFlipperUp = gp.buttons[4].pressed;
    frontLeftFlipperDown = gp.buttons[6].pressed;

    frontRightFlipperUp = gp.buttons[5].pressed;
    frontRightFlipperDown = gp.buttons[7].pressed;

    backLeftFlipperUp = gp.buttons[13].pressed;
    backLeftFlipperDown = gp.buttons[12].pressed;

    backRightFlipperUp = gp.buttons[0].pressed;
    backRightFlipperDown = gp.buttons[3].pressed;
    //End of Tread Defs

    //Arm definitions
    shutdown2 = gp.buttons[16].pressed;

    shoulderControls = applyDeadzone(gp.axes[1], 0.25);
    elbowControls = applyDeadzone(gp.axes[3], 0.25);

    turretControls = applyDeadzone(gp.axes[0], 0.25);
    wristControls = applyDeadzone(gp.axes[2], 0.25);

    clawOpen = gp.buttons[6].value;
    clawClose = gp.buttons[7].value;
    //End of Arm Defs

    try {
      if (!toggle_mode && (frontLeftFlipperUp || frontLeftFlipperDown || frontRightFlipperUp || frontRightFlipperDown || backLeftFlipperUp || backLeftFlipperDown || backRightFlipperUp || backRightFlipperDown || joystick1 != 0 || joystick2 != 0 || shutdown)) {
        tread_mode();
        console.log("Tread Mode");
      } 
      else if (toggle_mode && (frontLeftFlipperUp || frontLeftFlipperDown || frontRightFlipperUp || frontRightFlipperDown || backLeftFlipperUp || backLeftFlipperDown || backRightFlipperUp || backRightFlipperDown || joystick1 != 0 || joystick2 != 0 || shutdown)) {
        turret_mode();
        console.log("Turret Mode");
      }
      else {
        console.log("No Input");

        if (gp.buttons[14].pressed) {
          toggle();
          console.log("toggled");
        }

        var dictZero = {
          'shutdown': shutdown,
          'joystick1': joystick1,
          'joystick2': joystick2,
          'frontLeftFlipperUp': frontLeftFlipperUp,
          'frontLeftFlipperDown': frontLeftFlipperDown,
          'frontRightFlipperUp': frontRightFlipperUp,
          'frontRightFlipperDown': frontRightFlipperDown,
          'backLeftFlipperUp': backLeftFlipperUp,
          'backLeftFlipperDown': backLeftFlipperDown,
          'backRightFlipperUp': backRightFlipperUp,
          'backRightFlipperDown': backRightFlipperDown
        };

        shutdown = false;
        joystick1 = 0;
        joystick2 = 0;
        frontLeftFlipperUp = false;
        frontLeftFlipperDown = false;
        frontRightFlipperUp = false;
        frontRightFlipperDown = false;
        backLeftFlipperUp = false;
        backLeftFlipperDown = false;
        backRightFlipperUp = false;
        backRightFlipperDown = false;

        socket.volatile.emit({'info': dictZero});
      }
    }
    catch(err) {
      console.log("Error: " + err.message + "");
    }
    
  }
  console.log("Starting Up...");
  setInterval(run, 150);
</script>
</html>
